image: viaduck/ci

variables:
  GIT_SUBMODULE_STRATEGY: recursive

stages:
    - build
    - test
    - coverage
    - documentation

build:linux:x86_64:
    stage: build
    script:
        - mkdir build
        - cd build
        - cmake -GNinja ../ -DPREBUILT_BRANCH=x86_64-linux -DGTEST_SRC_DIR=/usr/src/googletest/
        - ninja
    artifacts:
        expire_in: 2h                   # do not pollute disk
        paths:
        - build/

test:linux:x86_64:
    stage: test
    script:
        - cd build
        - test/VDCommons_Test             # runs gtest target
    dependencies:
    - build:linux:x86_64

coverage:linux:x86_64:
    stage: coverage
    script:
        - cd build
        - ninja VDCommons_Coverage        # generate code coverage
    artifacts:
        paths:
        - build/test/coverage/         # coverage data
    dependencies:
    - build:linux:x86_64

documentation:linux:x86_64:
    stage: documentation
    script:
        - cd build
        - ninja VDCommons_doc             # generate doxygen code documentation
    artifacts:
        paths:
        - build/doc/html/                # doxygen documentation
    dependencies:
    - build:linux:x86_64

build:windows:x86:
    stage: build
    script:
        - update-alternatives --set i686-w64-mingw32-g++ /usr/bin/i686-w64-mingw32-g++-posix        # fix c++11 threading support on debian
        - update-alternatives --set i686-w64-mingw32-gcc /usr/bin/i686-w64-mingw32-gcc-posix
        - mkdir build-windows-x86
        - cd build-windows-x86
        - cmake -GNinja -DCMAKE_TOOLCHAIN_FILE=../external/toolchains/debian-jessie-mingw64-i686.cmake -DPREBUILT_BRANCH=i686-w64-mingw32 -DGTEST_SRC_DIR=/usr/src/googletest/ ../
        - ninja
    allow_failure: true

build:windows:x86_64:
    stage: build
    script:
        - update-alternatives --set x86_64-w64-mingw32-g++ /usr/bin/x86_64-w64-mingw32-g++-posix        # fix c++11 threading support on debian
        - update-alternatives --set x86_64-w64-mingw32-gcc /usr/bin/x86_64-w64-mingw32-gcc-posix
        - mkdir build-windows-x86_64
        - cd build-windows-x86_64
        - cmake -GNinja -DCMAKE_TOOLCHAIN_FILE=../external/toolchains/debian-jessie-mingw64-x86_64.cmake -DPREBUILT_BRANCH=x86_64-w64-mingw32 -DGTEST_SRC_DIR=/usr/src/googletest/ ../
        - ninja
    allow_failure: true

